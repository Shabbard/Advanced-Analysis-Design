@page "/PharmacistDashboard"

@using AdvancedAnalysisDesign.Services
@using AdvancedAnalysisDesign.Models.Database
@using AdvancedAnalysisDesign.Models.Payloads
@using AdvancedAnalysisDesign.Enums
@using Syncfusion.Blazor.Schedule
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject UserService UserService



<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-16">

    <MudGrid Style="flex-direction:column">

        <MudGrid Style="flex-direction:row" Justify="Justify.SpaceAround" Class="pb-10">
            <MudItem xs="6">
                <MudText Typo="Typo.h4" Class="pl-10">Daily Tasks</MudText>
            </MudItem>
            <MudItem xs="6">
                <MudText Align="Align.Right" Class="pr-10" Typo="Typo.h4">Lloyds Pharmacy - Woodbourne Road</MudText>
            </MudItem>
        </MudGrid>

        <MudGrid Style="flex-direction:row" Justify="Justify.SpaceEvenly">
            <MudItem xs="4">
                <MudPaper Elevation="4">
                    <MudText Class="pb-10 pt-5" Align="Align.Center" Typo="Typo.h5">Prescriptions Due</MudText>
                    <MudText Class="pb-10 pt-5" Align="Align.Center" Typo="Typo.h2" Color="Color.Primary">@prescriptionsDue</MudText>
                    <MudItem>
                        <MudButton OnClick="@PrescriptionListNav"
                                   Target="_blank"
                                   Variant="Variant.Text"
                                   EndIcon="@Icons.Material.Outlined.KeyboardArrowRight"
                                   IconColor="Color.Info"
                                   Color="Color.Info"
                                   Class="pl-5 pt-5 pb-4"
                                   Style="text-transform:unset; flex-direction:column-reverse">
                            <MudText>
                                Click to View
                            </MudText>
                        </MudButton>
                    </MudItem>
                </MudPaper>
            </MudItem>
            <MudItem xs="4">
                <MudPaper Elevation="4">
                    <MudText Class="pb-10 pt-5" Align="Align.Center" Typo="Typo.h5">Prescritions Prepared</MudText>
                    <MudText Class="pb-10 pt-5" Align="Align.Center" Typo="Typo.h2" Color="Color.Primary">@prescriptionsPrepared / @prescriptionsDue</MudText>
                    <MudItem>
                        <MudButton OnClick="@PrescriptionPrepNav"
                                   Target="_blank"
                                   Variant="Variant.Text"
                                   EndIcon="@Icons.Material.Outlined.KeyboardArrowRight"
                                   IconColor="Color.Info"
                                   Color="Color.Info"
                                   Class="pl-5 pt-5 pb-4"
                                   Style="text-transform:unset; flex-direction:column-reverse">
                            <MudText>
                                Click to View
                            </MudText>
                        </MudButton>
                    </MudItem>
                </MudPaper>
            </MudItem>
            <MudItem xs="4">
                <MudPaper Elevation="4">
                    <MudText Class="pb-10 pt-5" Align="Align.Center" Typo="Typo.h5">Prescriptions Collected</MudText>
                    <MudText Class="pb-10 pt-5" Align="Align.Center" Typo="Typo.h2" Color="Color.Primary">@prescriptionsCollected / @prescriptionsDue</MudText>
                    <MudItem>
                        <MudButton OnClick="@PrescriptionCollectionNav"
                                    Target="_blank"
                                    Variant="Variant.Text"
                                    EndIcon="@Icons.Material.Outlined.KeyboardArrowRight"
                                    IconColor="Color.Info"
                                    Color="Color.Info"
                                    Class="pl-5 pt-5 pb-4"
                                    Style="text-transform:unset; flex-direction:column-reverse">
                            <MudText>
                                Click to View
                            </MudText>
                        </MudButton>
                    </MudItem>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudGrid>
    <MudGrid Style="flex-direction:row">
        <MudItem xs="12" Class="mt-16">
            <MudPaper Elevation="5" Class="pt-2">

                <SfSchedule Readonly="true" TValue="Pickup" Width="100%" Height="650px" @bind-SelectedDate="@currentDate">
                    <ScheduleEventSettings DataSource="@pickupDatasource"></ScheduleEventSettings>
                </SfSchedule>

            </MudPaper>
        </MudItem>
    </MudGrid>

</MudContainer>

@code {
    List<Patient> patientWithPickups = new();
    int prescriptionsDue, prescriptionsPrepared, prescriptionsCollected;
    private List<PickupSchedulerPayload> pickupDatasource = new();
    private DateTime currentDate = DateTime.Now;

    private async Task PrescriptionCollectionNav()
    {
        NavigationManager.NavigateTo("/PrescriptionCollection");
    }

    private async Task PrescriptionListNav()
    {
        NavigationManager.NavigateTo("/PrescriptionList");
    }

    private async Task PrescriptionPrepNav()
    {
        NavigationManager.NavigateTo("/PrescriptionPreparation");
    }


    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.IsInRole(Role.Pharmacist.ToString()) || user.IsInRole(Role.Admin.ToString()))
        {
            patientWithPickups = await UserService.FetchAllPatientsWithPickups();
            (prescriptionsDue, prescriptionsPrepared, prescriptionsCollected) = await UserService.returnPrescriptionCounters(patientWithPickups);
            pickupDatasource = await UserService.returnPickupScheduler(patientWithPickups);
        }
        else
        {
            NavigationManager.NavigateTo("/", true);
        }
    }


}
