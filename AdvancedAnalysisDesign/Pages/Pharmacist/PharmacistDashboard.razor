@page "/PharmacistDashboard"

@using AdvancedAnalysisDesign.Services
@using AdvancedAnalysisDesign.Models.Database
@using AdvancedAnalysisDesign.Enums

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject UserService UserService

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-16">

    <MudGrid Style="flex-direction:column">

        <MudGrid Style="flex-direction:row" Justify="Justify.SpaceAround" Class="pb-10">
            <MudItem xs="6">
                <MudText Typo="Typo.h4" Class="pl-10">Daily Tasks</MudText>
            </MudItem>
            <MudItem xs="6">
                <MudText Align="Align.Right" Class="pr-10" Typo="Typo.h4">Lloyds Pharmacy - Woodbourne Road</MudText>
            </MudItem>
        </MudGrid>

        <MudGrid Style="flex-direction:row" Justify="Justify.SpaceEvenly">
            <MudItem xs="4">
                <MudPaper Elevation="4">
                    <MudText Class="pb-10 pt-5" Align="Align.Center" Typo="Typo.h5">Prescriptions Due</MudText>
                    <MudText Class="pb-10 pt-5" Align="Align.Center" Typo="Typo.h2" Color="Color.Primary">@prescriptionsDue</MudText>
                    <MudText Class="pr-5 pt-5 pb-4" Align="Align.Right" Color="Color.Default"><MudLink Color="Color.Info" Href="/PrescriptionsDue">Click to View ></MudLink></MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="4">
                <MudPaper Elevation="4">
                    <MudText Class="pb-10 pt-5" Align="Align.Center" Typo="Typo.h5">Prescritions Prepared</MudText>
                    <MudText Class="pb-10 pt-5" Align="Align.Center" Typo="Typo.h2" Color="Color.Primary">@prescriptionsPrepared / @prescriptionsDue</MudText>
                    <MudText Class="pr-5 pt-5 pb-4" Align="Align.Right" Color="Color.Default"><MudLink Color="Color.Info" Href="/PrescriptionsPrepared">Click to View ></MudLink></MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="4">
                <MudPaper Elevation="4">
                    <MudText Class="pb-10 pt-5" Align="Align.Center" Typo="Typo.h5">Prescriptions Collected</MudText>
                    <MudText Class="pb-10 pt-5" Align="Align.Center" Typo="Typo.h2" Color="Color.Primary">@prescriptionsCollected / @prescriptionsDue</MudText>
                    <MudText Class="pr-5 pt-5 pb-4" Align="Align.Right" ><MudLink Color="Color.Info" Href="/PrescriptionsCollected">Click to View ></MudLink></MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudGrid>
</MudContainer>

@code {
    List<Patient> patientWithPickups = new();
    int prescriptionsDue, prescriptionsPrepared, prescriptionsCollected;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.IsInRole(Role.Pharmacist.ToString()) || user.IsInRole(Role.Admin.ToString()))
        {
            patientWithPickups = await UserService.FetchAllPatientsWithPickups();
            (prescriptionsDue, prescriptionsPrepared, prescriptionsCollected) = await UserService.returnPrescriptionCounters(patientWithPickups);
        }
        else
        {
            NavigationManager.NavigateTo("/", true);
        }
    }

}
